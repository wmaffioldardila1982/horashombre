<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Horas Hombre - Google Sheets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
        
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .config-banner { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px 20px; margin: 20px; border-radius: 5px; }
        .config-banner.success { background: #d4edda; border-left-color: #28a745; }
        
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 150px; padding: 15px; text-align: center; cursor: pointer; background: #f5f5f5; border: none; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; border-bottom: 3px solid #667eea; color: #667eea; }
        
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; transition: border 0.3s; }
        
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; margin-right: 10px; margin-bottom: 10px; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffd89b 0%, #ff9a56 100%); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th { background: #4a69bd; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 13px; border: 1px solid #fff; }
        td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        tr:hover { background: #f9f9f9; }
        .delete-btn, .edit-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin: 2px; }
        .edit-btn { background: #3498db; }
        
        /* ESTILOS DE AUDITOR√çA */
        .clickable-number { color: #667eea; font-weight: bold; text-decoration: underline; cursor: pointer; }
        .clickable-number:hover { color: #764ba2; background-color: #f0f0f0; }
        
        /* ESTILOS TABLA ESTADISTICAS */
        .stats-table .frente-col { text-align: left; font-weight: 600; background: #f8f9fa; }
        
        /* SUBTOTAL Y TOTAL */
        .stats-table .total-row { background: #ecf0f1; color: #000000; font-weight: 700; font-size: 14px; border-top: 2px solid #95a5a6; }
        .stats-table .grand-total-row { background: #bdc3c7; color: #000000; font-weight: 800; font-size: 16px; border-top: 2px solid #2c3e50; }

        .periodo-selector { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .search-box { position: relative; margin-bottom: 15px; }
        
        /* ESTILOS SECCI√ìN FILTRO */
        .filter-section { background: #e1f5fe; border: 1px solid #81d4fa; border-radius: 8px; padding: 20px; margin-top: 30px; }
        .filter-controls { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 15px; }
        .filter-controls .form-group { margin-bottom: 0; flex: 1; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 10px; max-width: 600px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #ddd; }
        .close { font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
        
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .instructions { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .code-block { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; font-family: monospace; overflow-x: auto; margin: 10px 0; }
        .sync-status { display: inline-block; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .sync-status.synced { background: #d4edda; color: #155724; }
        .sync-status.error { background: #f8d7da; color: #721c24; }
        .sync-status.syncing { background: #fff3cd; color: #856404; }
        
        .trabajador-checkbox { display: flex; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .trabajador-checkbox:hover { background: #e3f2fd; }
        .trabajador-checkbox input[type="checkbox"] { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .trabajador-info { font-size: 12px; color: #666; margin-left: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Control de Horas Hombre</h1>
            <p>Sistema integrado con Google Sheets</p>
            <span id="syncStatus" class="sync-status"></span>
        </div>

        <div id="configBanner" class="config-banner">
            <h3>‚öôÔ∏è Configuraci√≥n Requerida</h3>
            <p>Para usar esta aplicaci√≥n, primero debes configurar la conexi√≥n con Google Sheets.</p>
        </div>
        
        <div class="tabs">
            <button class="tab" onclick="showTab('configuracion')">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab" onclick="showTab('registro')" id="tabRegistro" disabled>üìù Registro</button>
            <button class="tab" onclick="showTab('trabajadores')" id="tabTrabajadores" disabled>üë• Trabajadores</button>
            <button class="tab" onclick="showTab('estadisticas')" id="tabEstadisticas" disabled>üìà Estad√≠sticas</button>
            <button class="tab" onclick="showTab('datos')" id="tabDatos" disabled>üìã Datos Detallados</button>
        </div>
        
        <div class="content">
            <div id="configuracion" class="tab-content active">
                <h2>Configuraci√≥n de Google Sheets</h2>
                <div class="instructions">
                    <h3>üìã Instrucciones</h3>
                    <p>Pega aqu√≠ la URL de tu Web App de Apps Script (debe terminar en /exec).</p>
                    <div class="code-block">Ejemplo: https://script.google.com/macros/s/AKfycbx.../exec</div>
                </div>
                <form id="configForm">
                    <div class="form-group">
                        <label for="webAppUrl">URL de tu Web App:</label>
                        <input type="url" id="webAppUrl" placeholder="https://script.google.com/..." required>
                    </div>
                    <button type="submit">üíæ Guardar y Conectar</button>
                </form>
                <div id="loadingConfig" class="loading"><div class="spinner"></div><p>Probando conexi√≥n...</p></div>
            </div>

            <div id="registro" class="tab-content">
                <h2>Registrar Horas</h2>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="mostrarRegistroSimple()" class="btn-info">üìù Registro Simple</button>
                    <button onclick="mostrarRegistroMasivo()" class="btn-success">üë• Registro Masivo</button>
                    <button onclick="importarRegistrosExcel()" class="btn-warning">üì§ Importar Excel</button>
                    <input type="file" id="fileImportRegistros" accept=".xlsx,.xls" style="display:none" onchange="procesarArchivoRegistros(event)">
                </div>

                <div id="formSimple">
                    <form id="registroForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="fecha" required>
                            </div>
                            <div class="form-group">
                                <label>Trabajador:</label>
                                <select id="trabajadorSelect" required>
                                    <option value="">-- Seleccione --</option>
                                </select>
                            </div>
                        </div>
                        <div id="infoTrabajador" class="info-trabajador" style="display: none;"></div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Frente de Trabajo:</label>
                                <input type="text" id="frente" required list="frentesList" placeholder="Ej: K948">
                                <datalist id="frentesList">
                                    <option value="PLANEACI√ìN"><option value="ADMINISTRATIVO"><option value="K948">
                                    <option value="K940"><option value="K104">
                                </datalist>
                            </div>
                            <div class="form-group"><label>Horas Directa:</label><input type="number" id="horasDirecta" step="0.5" min="0" value="0"></div>
                            <div class="form-group"><label>Horas Indirecta:</label><input type="number" id="horasIndirecta" step="0.5" min="0" value="0"></div>
                        </div>
                        <button type="submit">Agregar Registro</button>
                        <button type="button" class="btn-info" onclick="sincronizar()">üîÑ Sincronizar</button>
                    </form>
                </div>

                <div id="formMasivo" style="display: none;">
                    <form id="registroMasivoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="fechaMasiva" required>
                            </div>
                            <div class="form-group">
                                <label>Frente de Trabajo:</label>
                                <input type="text" id="frenteMasivo" placeholder="Ej: K948" required list="frentesList">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group"><label>Horas Directa (defecto):</label><input type="number" id="horasDirectaMasiva" step="0.5" value="8"></div>
                            <div class="form-group"><label>Horas Indirecta (defecto):</label><input type="number" id="horasIndirectaMasiva" step="0.5" value="0"></div>
                        </div>

                        <div class="form-group">
                            <label>Selecciona los trabajadores:</label>
                            <div class="search-box">
                                <input type="text" id="buscarTrabajadorMasivo" placeholder="üîç Buscar trabajador..." onkeyup="filtrarTrabajadoresMasivo()">
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                                <div style="margin-bottom: 10px;">
                                    <button type="button" onclick="seleccionarTodosTrabajadores()" class="btn-info">‚úì Todos</button>
                                    <button type="button" onclick="deseleccionarTodosTrabajadores()" class="btn-secondary">‚úó Ninguno</button>
                                    <span id="contadorSeleccionados" style="margin-left: 15px; font-weight: 600;">0 seleccionados</span>
                                </div>
                                <div id="listaTrabajadoresMasivo"></div>
                            </div>
                        </div>

                        <button type="submit">üíæ Registrar Todos</button>
                        <button type="button" class="btn-secondary" onclick="mostrarRegistroSimple()">Cancelar</button>
                    </form>
                </div>
                <div id="loadingRegistro" class="loading"><div class="spinner"></div><p>Guardando...</p></div>
            </div>

            <div id="trabajadores" class="tab-content">
                <h2>Gesti√≥n de Trabajadores</h2>
                <button onclick="mostrarModalTrabajador()">‚ûï Nuevo Trabajador</button>
                <button class="btn-info" onclick="sincronizar()">üîÑ Sincronizar</button>
                <div class="search-box">
                    <input type="text" id="buscarTrabajador" placeholder="üîç Buscar..." onkeyup="filtrarTrabajadores()">
                </div>
                <div style="overflow-x: auto;">
                    <table id="tablaTrabajadores">
                        <thead><tr><th>C√©dula</th><th>Nombre</th><th>Cargo</th><th>Tipo</th><th>Acciones</th></tr></thead>
                        <tbody id="bodyTrabajadores"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="estadisticas" class="tab-content">
                <h2>Estad√≠sticas del Proyecto</h2>
                
                <div class="periodo-selector">
                    <label>Desde:</label><input type="date" id="fechaInicio">
                    <label>Hasta:</label><input type="date" id="fechaFin">
                    <button onclick="actualizarEstadisticas()">Actualizar Todo</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th rowspan="3">FRENTE</th>
                                <th colspan="2" rowspan="2">PERSONAL (Click ver)</th>
                                <th colspan="4">HORAS HOMBRE (HH)</th>
                            </tr>
                            <tr>
                                <th colspan="2">PER√çODO</th>
                                <th colspan="2">ACUMULADO</th>
                            </tr>
                            <tr>
                                <th>DIRECTA</th><th>INDIRECTA</th>
                                <th>DIRECTA</th><th>INDIRECTA</th>
                                <th>DIRECTA</th><th>INDIRECTA</th>
                            </tr>
                        </thead>
                        <tbody id="statsBody"></tbody>
                    </table>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; color: #667eea;">üë• Resumen por Cargo (Global)</h3>
                <div style="overflow-x: auto;">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding-left: 20px;">CARGO</th>
                                <th>CANTIDAD (Click para ver)</th>
                                <th>PORCENTAJE</th>
                            </tr>
                        </thead>
                        <tbody id="statsCargosBody"></tbody>
                    </table>
                </div>

                <div class="filter-section">
                    <h3 style="color: #0277bd; margin-bottom: 15px;">üîé Reporte: Cantidad de Personal por Frente y Cargo</h3>
                    <p style="font-size: 13px; color: #555; margin-bottom: 15px;">Muestra cu√°ntas personas de cada cargo trabajaron en cada frente durante el per√≠odo seleccionado.</p>
                    
                    <div class="filter-controls">
                        <div class="form-group">
                            <label for="filtroFrente">Seleccionar Frente:</label>
                            <select id="filtroFrente">
                                <option value="TODOS">-- Todos los Frentes --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filtroCargo">Seleccionar Cargo:</label>
                            <select id="filtroCargo">
                                <option value="TODOS">-- Todos los Cargos --</option>
                            </select>
                        </div>
                        <button onclick="consultarFiltroDetallado()" class="btn-info" style="margin-bottom: 0;">üîç Consultar</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="stats-table" id="tablaFiltroDetallado" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="text-align:left; padding-left:20px;">FRENTE</th>
                                    <th style="text-align:left;">CARGO</th>
                                    <th>CANTIDAD DE PERSONAS</th>
                                </tr>
                            </thead>
                            <tbody id="bodyFiltroDetallado">
                            </tbody>
                        </table>
                        <p id="mensajeSinResultados" style="display:none; text-align: center; color: #666; padding: 20px;">No se encontraron registros.</p>
                    </div>
                </div>

            </div>
            
            <div id="datos" class="tab-content">
                <h2>Registros Detallados</h2>
                <div style="overflow-x: auto;">
                    <table id="tablaRegistros">
                        <thead><tr><th>Fecha</th><th>Trabajador</th><th>C√©dula</th><th>Frente</th><th>Horas</th><th>Acci√≥n</th></tr></thead>
                        <tbody id="bodyRegistros"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modalTrabajador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuevo Trabajador</h2>
                <span class="close" onclick="cerrarModalTrabajador()">&times;</span>
            </div>
            <form id="formTrabajador">
                <input type="hidden" id="cedulaOriginal">
                <div class="form-group"><label>C√©dula:</label><input type="text" id="cedula" required></div>
                <div class="form-group"><label>Nombre Completo:</label><input type="text" id="nombreCompleto" required></div>
                <div class="form-group"><label>Cargo:</label><input type="text" id="cargo" required></div>
                <div class="form-group"><label>Tipo de Cargo:</label>
                    <select id="tipoCargo" required>
                        <option value="Directa">Directa</option>
                        <option value="Indirecta">Indirecta</option>
                    </select>
                </div>
                <div class="form-group"><label>Fecha Ingreso:</label><input type="date" id="fechaIngreso" required></div>
                <div class="form-group"><label>Fecha Retiro:</label><input type="date" id="fechaRetiro"></div>
                <button type="submit">Guardar Trabajador</button>
                <button type="button" class="btn-secondary" onclick="cerrarModalTrabajador()">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let registros = [];
        let trabajadores = [];
        let webAppUrl = '';
        let isConfigured = false;
        
        cargarConfiguracion();
        
        // Fechas por defecto
        document.getElementById('fecha').valueAsDate = new Date();
        document.getElementById('fechaMasiva').valueAsDate = new Date();
        const hoy = new Date();
        document.getElementById('fechaFin').valueAsDate = hoy;
        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        document.getElementById('fechaInicio').valueAsDate = inicioMes;

        // --- L√ìGICA DE VALIDACI√ìN ---

        function existeRegistro(fecha, cedula) {
            return registros.find(r => r.fecha === fecha && r.trabajadorCedula === cedula);
        }

        // --- L√ìGICA DE FORMULARIOS ---

        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            webAppUrl = document.getElementById('webAppUrl').value.trim();
            document.getElementById('loadingConfig').classList.add('active');
            try {
                const response = await fetch(webAppUrl + '?action=getTrabajadores');
                if (!response.ok) throw new Error('Error respuesta');
                localStorage.setItem('webAppUrl', webAppUrl);
                isConfigured = true;
                document.getElementById('loadingConfig').classList.remove('active');
                await sincronizar();
                alert('‚úÖ Configuraci√≥n guardada');
                showTab('registro');
            } catch (error) {
                document.getElementById('loadingConfig').classList.remove('active');
                alert('‚ùå Error al conectar: ' + error.message);
            }
        });
        
        // REGISTRO SIMPLE
        document.getElementById('registroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isConfigured) return alert('Configura primero la conexi√≥n');
            
            const horasDirecta = parseFloat(document.getElementById('horasDirecta').value) || 0;
            const horasIndirecta = parseFloat(document.getElementById('horasIndirecta').value) || 0;
            if (horasDirecta === 0 && horasIndirecta === 0) return alert('Ingrese horas');

            const cedula = document.getElementById('trabajadorSelect').value;
            const fecha = document.getElementById('fecha').value;
            const trabajador = trabajadores.find(t => t.cedula === cedula);
            
            const duplicado = existeRegistro(fecha, cedula);
            if (duplicado) {
                alert(`‚ö†Ô∏è ALERTA: ${trabajador.nombreCompleto} ya tiene registro en el frente "${duplicado.frente}".`);
                return;
            }
            
            const registro = {
                id: Date.now() + Math.random(),
                fecha: fecha,
                trabajadorNombre: trabajador.nombreCompleto,
                trabajadorCedula: trabajador.cedula,
                frente: document.getElementById('frente').value.toUpperCase(),
                horasDirecta: horasDirecta,
                horasIndirecta: horasIndirecta
            };
            
            enviarRegistro(registro, this);
        });

        // REGISTRO MASIVO
        document.getElementById('registroMasivoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isConfigured) return alert('Configura primero la conexi√≥n');
            
            const checkboxes = document.querySelectorAll('#listaTrabajadoresMasivo input[type="checkbox"]:checked');
            const seleccionados = Array.from(checkboxes).map(cb => cb.value);
            
            if (seleccionados.length === 0) return alert('Selecciona trabajadores');
            
            const fecha = document.getElementById('fechaMasiva').value;
            const frente = document.getElementById('frenteMasivo').value.toUpperCase();
            const hDir = parseFloat(document.getElementById('horasDirectaMasiva').value) || 0;
            const hIndir = parseFloat(document.getElementById('horasIndirectaMasiva').value) || 0;
            
            if (!confirm(`¬øRegistrar ${seleccionados.length} trabajadores en ${frente}?`)) return;
            
            document.getElementById('loadingRegistro').classList.add('active');
            let exitosos = 0;
            let omitidos = 0;
            let nombresOmitidos = [];
            
            for (const cedula of seleccionados) {
                const trabajador = trabajadores.find(t => t.cedula === cedula);
                if (!trabajador) continue;
                
                const duplicado = existeRegistro(fecha, cedula);
                if (duplicado) {
                    omitidos++;
                    nombresOmitidos.push(trabajador.nombreCompleto);
                    continue;
                }
                
                const reg = {
                    fecha: fecha,
                    trabajadorNombre: trabajador.nombreCompleto,
                    trabajadorCedula: trabajador.cedula,
                    frente: frente,
                    horasDirecta: hDir,
                    horasIndirecta: hIndir
                };
                
                try {
                    await fetch(webAppUrl, { method: 'POST', body: JSON.stringify({ action: 'addRegistro', ...reg }) });
                    registros.push(reg);
                    exitosos++;
                } catch (err) { console.error(err); }
            }
            
            actualizarTabla();
            actualizarEstadisticas();
            document.getElementById('loadingRegistro').classList.remove('active');
            
            let mensaje = `‚úì Proceso finalizado:\n- Guardados: ${exitosos}`;
            if (omitidos > 0) {
                mensaje += `\n- ‚ö†Ô∏è OMITIDOS (Duplicados): ${omitidos}`;
                mensaje += `\n\nNombres:\n${nombresOmitidos.slice(0,5).join('\n')}${nombresOmitidos.length > 5 ? '...' : ''}`;
            }
            
            alert(mensaje);
            mostrarRegistroSimple();
        });

        function mostrarRegistroSimple() {
            document.getElementById('formSimple').style.display = 'block';
            document.getElementById('formMasivo').style.display = 'none';
        }

        function mostrarRegistroMasivo() {
            document.getElementById('formSimple').style.display = 'none';
            document.getElementById('formMasivo').style.display = 'block';
            cargarListaTrabajadoresMasivo();
        }

        function cargarListaTrabajadoresMasivo() {
            const lista = document.getElementById('listaTrabajadoresMasivo');
            lista.innerHTML = '';
            trabajadores.filter(t => !t.fechaRetiro).sort((a,b) => a.nombreCompleto.localeCompare(b.nombreCompleto))
                .forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'trabajador-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="m_${t.cedula}" value="${t.cedula}" onchange="actualizarContador()">
                        <label for="m_${t.cedula}"><strong>${t.nombreCompleto}</strong> <span style="font-size:11px; color:#666">(${t.cargo})</span></label>
                    `;
                    lista.appendChild(div);
                });
            actualizarContador();
        }

        function filtrarTrabajadoresMasivo() {
            const txt = document.getElementById('buscarTrabajadorMasivo').value.toLowerCase();
            document.querySelectorAll('.trabajador-checkbox').forEach(div => {
                div.style.display = div.textContent.toLowerCase().includes(txt) ? 'flex' : 'none';
            });
        }
        
        function seleccionarTodosTrabajadores() {
            document.querySelectorAll('#listaTrabajadoresMasivo input[type="checkbox"]').forEach(cb => {
                if(cb.parentElement.style.display !== 'none') cb.checked = true;
            });
            actualizarContador();
        }

        function deseleccionarTodosTrabajadores() {
            document.querySelectorAll('#listaTrabajadoresMasivo input[type="checkbox"]').forEach(cb => cb.checked = false);
            actualizarContador();
        }

        function actualizarContador() {
            const n = document.querySelectorAll('#listaTrabajadoresMasivo input:checked').length;
            document.getElementById('contadorSeleccionados').textContent = `${n} seleccionados`;
        }

        async function enviarRegistro(registro, form) {
            document.getElementById('loadingRegistro').classList.add('active');
            try {
                await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'addRegistro', ...registro })
                });
                registros.push(registro);
                actualizarTabla();
                actualizarEstadisticas();
                form.reset();
                document.getElementById('fecha').valueAsDate = new Date();
                document.getElementById('horasDirecta').value = '0';
                document.getElementById('horasIndirecta').value = '0';
                alert('‚úì Guardado');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            } finally {
                document.getElementById('loadingRegistro').classList.remove('active');
            }
        }

        // --- ESTAD√çSTICAS ---

        function actualizarEstadisticas() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const registrosPeriodo = registros.filter(r => r.fecha >= fechaInicio && r.fecha <= fechaFin);
            
            actualizarSelectsFiltro(registrosPeriodo);

            const stats = {};
            registros.forEach(r => {
                if (r.fecha <= fechaFin) {
                    if (!stats[r.frente]) initStats(stats, r.frente);
                    stats[r.frente].hDirAcum += r.horasDirecta;
                    stats[r.frente].hIndirAcum += r.horasIndirecta;
                }
            });
            registrosPeriodo.forEach(r => {
                if (!stats[r.frente]) initStats(stats, r.frente);
                if (r.horasDirecta > 0) stats[r.frente].dirP.add(r.trabajadorCedula);
                if (r.horasIndirecta > 0) stats[r.frente].indirP.add(r.trabajadorCedula);
                stats[r.frente].hDirP += r.horasDirecta;
                stats[r.frente].hIndirP += r.horasIndirecta;
            });

            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = '';
            
            let tDirP = 0, tIndirP = 0, tHDirP = 0, tHIndirP = 0, tHDirAcum = 0, tHIndirAcum = 0;

            Object.keys(stats).sort().forEach(frente => {
                const s = stats[frente];
                const cDir = s.dirP.size;
                const cIndir = s.indirP.size;
                
                tDirP += cDir; tIndirP += cIndir;
                tHDirP += s.hDirP; tHIndirP += s.hIndirP;
                tHDirAcum += s.hDirAcum; tHIndirAcum += s.hIndirAcum;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="frente-col">${frente}</td>
                    <td class="clickable-number" onclick="verDetalle('${frente}','Directa','${[...s.dirP]}')">${cDir}</td>
                    <td class="clickable-number" onclick="verDetalle('${frente}','Indirecta','${[...s.indirP]}')">${cIndir}</td>
                    <td>${s.hDirP.toFixed(2)}</td>
                    <td>${s.hIndirP.toFixed(2)}</td>
                    <td>${s.hDirAcum.toFixed(2)}</td>
                    <td>${s.hIndirAcum.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });

            // SUBTOTAL
            const trTotal = document.createElement('tr');
            trTotal.className = 'total-row';
            trTotal.innerHTML = `
                <td class="frente-col">SUBTOTAL</td>
                <td>${tDirP}</td>
                <td>${tIndirP}</td>
                <td>${tHDirP.toFixed(2)}</td>
                <td>${tHIndirP.toFixed(2)}</td>
                <td>${tHDirAcum.toFixed(2)}</td>
                <td>${tHIndirAcum.toFixed(2)}</td>
            `;
            tbody.appendChild(trTotal);

            // TOTAL
            const trGranTotal = document.createElement('tr');
            trGranTotal.className = 'grand-total-row';
            trGranTotal.innerHTML = `
                <td class="frente-col">TOTAL</td>
                <td colspan="2">${tDirP + tIndirP}</td>
                <td colspan="2">${(tHDirP + tHIndirP).toFixed(2)}</td>
                <td colspan="2">${(tHDirAcum + tHIndirAcum).toFixed(2)}</td>
            `;
            tbody.appendChild(trGranTotal);

            // CARGOS
            const statsCargos = {};
            const personasTotal = new Set();
            registrosPeriodo.forEach(r => {
                personasTotal.add(r.trabajadorCedula);
                const trab = trabajadores.find(t => t.cedula === r.trabajadorCedula);
                let cargo = trab ? trab.cargo.toString().toUpperCase().replace(/\s+/g, ' ').trim() : 'SIN DEFINIR';
                if (!statsCargos[cargo]) statsCargos[cargo] = new Set();
                statsCargos[cargo].add(r.trabajadorCedula);
            });

            const tbodyCargos = document.getElementById('statsCargosBody');
            tbodyCargos.innerHTML = '';
            const lista = Object.keys(statsCargos).map(c => ({nombre: c, total: statsCargos[c].size, ids: [...statsCargos[c]]}))
                                                 .sort((a,b) => b.total - a.total);
            
            lista.forEach(item => {
                const pct = personasTotal.size > 0 ? (item.total / personasTotal.size * 100).toFixed(1) : 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align: left; padding-left: 20px; font-weight: 600;">${item.nombre}</td>
                    <td class="clickable-number" onclick="verDetalleCargo('${item.nombre}', '${item.ids}')">${item.total}</td>
                    <td>${pct}%</td>
                `;
                tbodyCargos.appendChild(tr);
            });
            const trTotalCargos = document.createElement('tr');
            trTotalCargos.className = 'total-row';
            trTotalCargos.innerHTML = `<td style="text-align: left; padding-left: 20px;">TOTAL PERSONAS √öNICAS</td><td>${personasTotal.size}</td><td>100%</td>`;
            tbodyCargos.appendChild(trTotalCargos);
        }

        // --- NUEVA L√ìGICA REPORTE AGRUPADO ---
        
        function actualizarSelectsFiltro(registrosPeriodo) {
            const selectFrente = document.getElementById('filtroFrente');
            const selectCargo = document.getElementById('filtroCargo');
            const frenteActual = selectFrente.value;
            const cargoActual = selectCargo.value;

            const frentes = new Set();
            const cargos = new Set();

            registrosPeriodo.forEach(r => {
                frentes.add(r.frente);
                const trab = trabajadores.find(t => t.cedula === r.trabajadorCedula);
                if(trab) cargos.add(trab.cargo.toString().toUpperCase().replace(/\s+/g, ' ').trim());
            });

            selectFrente.innerHTML = '<option value="TODOS">-- Todos los Frentes --</option>';
            [...frentes].sort().forEach(f => {
                const op = document.createElement('option');
                op.value = f; op.text = f;
                selectFrente.appendChild(op);
            });
            selectFrente.value = frenteActual; 

            selectCargo.innerHTML = '<option value="TODOS">-- Todos los Cargos --</option>';
            [...cargos].sort().forEach(c => {
                const op = document.createElement('option');
                op.value = c; op.text = c;
                selectCargo.appendChild(op);
            });
            selectCargo.value = cargoActual; 
        }

        function consultarFiltroDetallado() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const frenteSel = document.getElementById('filtroFrente').value;
            const cargoSel = document.getElementById('filtroCargo').value;

            const registrosFiltrados = registros.filter(r => {
                if (r.fecha < fechaInicio || r.fecha > fechaFin) return false;
                if (frenteSel !== 'TODOS' && r.frente !== frenteSel) return false;
                
                const trab = trabajadores.find(t => t.cedula === r.trabajadorCedula);
                const cargoTrab = trab ? trab.cargo.toString().toUpperCase().replace(/\s+/g, ' ').trim() : 'SIN DEFINIR';
                
                if (cargoSel !== 'TODOS' && cargoTrab !== cargoSel) return false;
                return true;
            });

            // AGRUPAR POR FRENTE + CARGO
            const agrupacion = {};

            registrosFiltrados.forEach(r => {
                const trab = trabajadores.find(t => t.cedula === r.trabajadorCedula);
                const cargo = trab ? trab.cargo.toString().toUpperCase().replace(/\s+/g, ' ').trim() : 'SIN DEFINIR';
                const frente = r.frente;
                const clave = `${frente}|${cargo}`;
                
                if (!agrupacion[clave]) {
                    agrupacion[clave] = { frente: frente, cargo: cargo, personas: new Set() };
                }
                agrupacion[clave].personas.add(r.trabajadorCedula);
            });

            // CONVERTIR A LISTA
            const lista = Object.values(agrupacion).map(item => ({
                frente: item.frente,
                cargo: item.cargo,
                cantidad: item.personas.size
            })).sort((a, b) => {
                if (a.frente < b.frente) return -1;
                if (a.frente > b.frente) return 1;
                if (a.cargo < b.cargo) return -1;
                if (a.cargo > b.cargo) return 1;
                return 0;
            });

            // RENDERIZAR
            const tbody = document.getElementById('bodyFiltroDetallado');
            const tabla = document.getElementById('tablaFiltroDetallado');
            const mensaje = document.getElementById('mensajeSinResultados');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                tabla.style.display = 'none';
                mensaje.style.display = 'block';
            } else {
                tabla.style.display = 'table';
                mensaje.style.display = 'none';
                
                lista.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="text-align:left; padding-left:20px;">${item.frente}</td>
                        <td style="text-align:left;">${item.cargo}</td>
                        <td style="font-weight:bold;">${item.cantidad}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function initStats(stats, frente) {
            stats[frente] = { dirP: new Set(), indirP: new Set(), hDirP: 0, hIndirP: 0, hDirAcum: 0, hIndirAcum: 0 };
        }

        function verDetalle(frente, tipo, idsStr) {
            if(!idsStr) return alert("Nadie en este grupo.");
            mostrarAlerta(`Personal en ${frente} (${tipo})`, idsStr.split(','));
        }
        function verDetalleCargo(cargo, idsStr) {
            if(!idsStr) return alert("Nadie en este cargo.");
            mostrarAlerta(`Personal con cargo: ${cargo}`, idsStr.split(','));
        }
        function mostrarAlerta(titulo, ids) {
            const nombres = ids.map(id => {
                const t = trabajadores.find(tr => tr.cedula === id);
                return t ? `${t.nombreCompleto}` : `Desconocido (${id})`;
            }).sort();
            alert(`${titulo}\n------------------\n${nombres.join('\n')}\n------------------\nTotal: ${nombres.length}`);
        }

        // --- GESTI√ìN TRABAJADORES ---
        document.getElementById('formTrabajador').addEventListener('submit', async function(e) {
            e.preventDefault();
            const cedula = document.getElementById('cedula').value;
            const cedulaOriginal = document.getElementById('cedulaOriginal').value;
            const data = {
                cedula: cedula,
                nombreCompleto: document.getElementById('nombreCompleto').value,
                cargo: document.getElementById('cargo').value,
                tipoCargo: document.getElementById('tipoCargo').value,
                fechaIngreso: document.getElementById('fechaIngreso').value,
                fechaRetiro: document.getElementById('fechaRetiro').value || ''
            };
            try {
                await fetch(webAppUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: cedulaOriginal ? 'updateTrabajador' : 'addTrabajador', ...data })
                });
                if(cedulaOriginal) {
                    const idx = trabajadores.findIndex(t => t.cedula === cedulaOriginal);
                    if(idx !== -1) trabajadores[idx] = data;
                } else { trabajadores.push(data); }
                actualizarTablaTrabajadores(); actualizarSelectTrabajadores(); cerrarModalTrabajador(); alert('‚úì Trabajador guardado');
            } catch (error) { alert('‚ùå Error'); }
        });

        // --- SINCRONIZACI√ìN Y CARGA DE DATOS ---
        
        function cargarConfiguracion() {
            webAppUrl = localStorage.getItem('webAppUrl') || '';
            if (webAppUrl) {
                document.getElementById('webAppUrl').value = webAppUrl;
                isConfigured = true;
                document.getElementById('configBanner').className = 'config-banner success';
                document.getElementById('configBanner').innerHTML = '<h3>‚úÖ Sistema Conectado</h3>';
                document.querySelectorAll('button[disabled]').forEach(b => b.disabled = false);
                sincronizar();
            }
        }

        async function sincronizar() {
            if (!isConfigured) return;
            setSyncStatus('syncing');
            try {
                const resT = await fetch(webAppUrl + '?action=getTrabajadores');
                const dataT = await resT.json();
                trabajadores = dataT.map(r => ({
                    cedula: String(r[0]), nombreCompleto: r[1], cargo: r[2], tipoCargo: r[3],
                    fechaIngreso: normalizarFecha(r[4]), fechaRetiro: normalizarFecha(r[5])
                }));
                const resR = await fetch(webAppUrl + '?action=getRegistros');
                const dataR = await resR.json();
                registros = dataR.map(r => ({
                    id: r[0] || Date.now() + Math.random(),
                    fecha: normalizarFecha(r[1]),
                    trabajadorNombre: r[2], trabajadorCedula: String(r[3]),
                    frente: r[4], horasDirecta: Number(r[5])||0, horasIndirecta: Number(r[6])||0
                }));
                actualizarTablaTrabajadores(); actualizarSelectTrabajadores(); actualizarTabla(); actualizarEstadisticas();
                setSyncStatus('synced');
            } catch (error) { console.error(error); setSyncStatus('error'); }
        }

        function normalizarFecha(f) {
            if (!f) return null;
            if (typeof f === 'number') {
                const d = new Date(1899, 11, 30);
                d.setDate(d.getDate() + (f - 1));
                return d.toISOString().split('T')[0];
            }
            if (typeof f === 'string' && f.includes('T')) return f.split('T')[0];
            return f;
        }

        function setSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            el.className = 'sync-status ' + status;
            el.textContent = status === 'synced' ? '‚úì Sincronizado' : (status === 'syncing' ? '‚ü≥ Sincronizando...' : '‚ö† Error');
        }

        function actualizarTablaTrabajadores() {
            const tbody = document.getElementById('bodyTrabajadores');
            tbody.innerHTML = trabajadores.map(t => `
                <tr><td>${t.cedula}</td><td>${t.nombreCompleto}</td><td>${t.cargo}</td><td>${t.tipoCargo}</td>
                <td><button class="edit-btn" onclick="editarTrabajador('${t.cedula}')">Editar</button></td></tr>`).join('');
        }
        
        function actualizarSelectTrabajadores() {
            const s = document.getElementById('trabajadorSelect');
            s.innerHTML = '<option value="">-- Seleccione --</option>' + 
                trabajadores.filter(t=>!t.fechaRetiro).sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto))
                .map(t => `<option value="${t.cedula}">${t.nombreCompleto}</option>`).join('');
        }

        function actualizarTabla() {
            const tbody = document.getElementById('bodyRegistros');
            registros.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            tbody.innerHTML = registros.slice(0, 200).map(r => `
                <tr><td>${r.fecha}</td><td>${r.trabajadorNombre}</td><td>${r.trabajadorCedula}</td>
                <td>${r.frente}</td><td>${(r.horasDirecta+r.horasIndirecta).toFixed(1)}</td>
                <td><button class="delete-btn" onclick="eliminarRegistro('${r.id}')">Eliminar</button></td></tr>`).join('');
        }
        
        async function eliminarRegistro(id) {
            if(!confirm('¬øEliminar?')) return;
            const reg = registros.find(r => r.id == id);
            if(!reg) return;
            document.getElementById('loadingRegistro').classList.add('active');
            try {
                await fetch(webAppUrl, {
                    method: 'POST', 
                    body: JSON.stringify({ action: 'deleteRegistro', id:id, fecha:reg.fecha, cedula:reg.trabajadorCedula })
                });
                registros = registros.filter(r => r.id != id);
                actualizarTabla(); actualizarEstadisticas(); alert('‚úì Eliminado');
            } catch (e) { alert('Error al eliminar'); }
            finally { document.getElementById('loadingRegistro').classList.remove('active'); }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            if(id === 'estadisticas') actualizarEstadisticas();
        }

        function mostrarModalTrabajador() {
            document.getElementById('cedulaOriginal').value = '';
            document.getElementById('formTrabajador').reset();
            document.getElementById('modalTitle').textContent = 'Nuevo Trabajador';
            document.getElementById('modalTrabajador').style.display = 'block';
        }

        function editarTrabajador(cedula) {
            const t = trabajadores.find(x => x.cedula === cedula);
            if(!t) return;
            document.getElementById('cedulaOriginal').value = cedula;
            document.getElementById('cedula').value = t.cedula;
            document.getElementById('nombreCompleto').value = t.nombreCompleto;
            document.getElementById('cargo').value = t.cargo;
            document.getElementById('tipoCargo').value = t.tipoCargo;
            document.getElementById('fechaIngreso').value = t.fechaIngreso;
            document.getElementById('fechaRetiro').value = t.fechaRetiro || '';
            document.getElementById('modalTitle').textContent = 'Editar Trabajador';
            document.getElementById('modalTrabajador').style.display = 'block';
        }

        function cerrarModalTrabajador() { document.getElementById('modalTrabajador').style.display = 'none'; }
        
        function filtrarTrabajadores() {
            const q = document.getElementById('buscarTrabajador').value.toLowerCase();
            document.querySelectorAll('#bodyTrabajadores tr').forEach(tr => {
                tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }
        
        function importarRegistrosExcel() { document.getElementById('fileImportRegistros').click(); }
        function procesarArchivoRegistros(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(ev) {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(!json.length) return alert('Excel vac√≠o');
                    document.getElementById('loadingRegistro').classList.add('active');
                    let ok=0, err=0;
                    for(const row of json) {
                        const ced = row['Cedula']||row['CEDULA']||row['cedula'];
                        const fec = row['Fecha']||row['FECHA'];
                        const fre = row['Frente']||row['FRENTE'];
                        if(!ced||!fec||!fre) { err++; continue; }
                        const trab = trabajadores.find(t=>t.cedula == ced);
                        if(!trab) { err++; continue; }
                        let fechaFmt = fec;
                        if(typeof fec === 'number') fechaFmt = normalizarFecha(fec);
                        if(existeRegistro(fechaFmt, String(ced))) { err++; continue; }
                        const reg = {
                            fecha: fechaFmt, trabajadorNombre: trab.nombreCompleto, trabajadorCedula: trab.cedula,
                            frente: String(fre).toUpperCase(),
                            horasDirecta: row['Horas Directa']||0, horasIndirecta: row['Horas Indirecta']||0
                        };
                        try {
                            await fetch(webAppUrl, { method:'POST', body:JSON.stringify({action:'addRegistro', ...reg})});
                            registros.push(reg);
                            ok++;
                        } catch(e){ err++; }
                    }
                    actualizarTabla(); actualizarEstadisticas();
                    alert(`Importados: ${ok}, Errores/Duplicados: ${err}`);
                } catch(e) { alert('Error Excel'); }
                finally { document.getElementById('loadingRegistro').classList.remove('active'); }
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>