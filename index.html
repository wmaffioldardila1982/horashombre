<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background-color: #f0f0f0;
        }
        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        button.success {
            background-color: #28a745;
        }
        button.success:hover {
            background-color: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .actions {
            white-space: nowrap;
        }
        .actions button {
            padding: 6px 12px;
            margin: 2px;
            font-size: 12px;
        }
        .message {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .search-filters {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .stat-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stat-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .summary-table {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema de Gestión de Trabajadores</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('workers')">Trabajadores</button>
            <button class="tab" onclick="showTab('records')">Registros</button>
            <button class="tab" onclick="showTab('reports')">Trabajadores por Cargo</button>
        </div>

        <div id="message" class="message"></div>

        <!-- Tab Trabajadores -->
        <div id="workers" class="tab-content active">
            <h2>Gestión de Trabajadores</h2>
            
            <form id="workerForm">
                <input type="hidden" id="workerId" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerName">Nombre:</label>
                        <input type="text" id="workerName" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="workerCargo">Cargo:</label>
                        <select id="workerCargo" name="cargo" required>
                            <option value="">Seleccione un cargo</option>
                            <option value="Operador">Operador</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Técnico">Técnico</option>
                            <option value="Administrador">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerTipo">Tipo:</label>
                        <select id="workerTipo" name="tipo" required>
                            <option value="">Seleccione un tipo</option>
                            <option value="Directo">Directo</option>
                            <option value="Indirecto">Indirecto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workerFechaIngreso">Fecha de Ingreso:</label>
                        <input type="date" id="workerFechaIngreso" name="fechaIngreso" required>
                    </div>
                </div>
                <button type="submit" class="success">Guardar Trabajador</button>
                <button type="button" onclick="resetWorkerForm()">Limpiar</button>
            </form>

            <table id="workersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Cargo</th>
                        <th>Tipo</th>
                        <th>Fecha Ingreso</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <!-- Tab Registros -->
        <div id="records" class="tab-content">
            <h2>Gestión de Registros</h2>
            
            <form id="recordForm">
                <input type="hidden" id="recordId" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="recordTrabajadorId">Trabajador:</label>
                        <select id="recordTrabajadorId" name="trabajadorId" required>
                            <option value="">Seleccione un trabajador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordFecha">Fecha:</label>
                        <input type="date" id="recordFecha" name="fecha" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="recordHoraEntrada">Hora Entrada:</label>
                        <input type="time" id="recordHoraEntrada" name="horaEntrada" required>
                    </div>
                    <div class="form-group">
                        <label for="recordHoraSalida">Hora Salida:</label>
                        <input type="time" id="recordHoraSalida" name="horaSalida">
                    </div>
                </div>
                <button type="submit" class="success">Guardar Registro</button>
                <button type="button" onclick="resetRecordForm()">Limpiar</button>
            </form>

            <table id="recordsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Trabajador</th>
                        <th>Fecha</th>
                        <th>Hora Entrada</th>
                        <th>Hora Salida</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <!-- Tab Trabajadores por Cargo -->
        <div id="reports" class="tab-content">
            <h2>Trabajadores por Cargo</h2>
            
            <div class="search-filters">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fechaInicio">Fecha Inicio:</label>
                        <input type="date" id="fechaInicio">
                    </div>
                    <div class="form-group">
                        <label for="fechaFin">Fecha Fin:</label>
                        <input type="date" id="fechaFin">
                    </div>
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button type="button" onclick="generateReport()" class="success">Generar Reporte</button>
                    </div>
                </div>
            </div>

            <div id="reportResults" style="display: none;">
                <div class="stats-container" id="statsContainer">
                    <!-- Las estadísticas se generarán dinámicamente aquí -->
                </div>

                <div class="summary-table">
                    <h3>Resumen por Cargo</h3>
                    <table id="summaryTable">
                        <thead>
                            <tr>
                                <th>Cargo</th>
                                <th>Total Trabajadores</th>
                                <th>Directos</th>
                                <th>Indirectos</th>
                                <th>% Directos</th>
                                <th>% Indirectos</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let workers = [];
        let records = [];

        // Funciones de navegación
        function showTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar la pestaña seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos según la pestaña
            if (tabName === 'workers') {
                loadWorkers();
            } else if (tabName === 'records') {
                loadRecords();
                loadWorkersForSelect();
            }
        }

        // Funciones de utilidad
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // Funciones para trabajadores
        function loadWorkers() {
            google.script.run
                .withSuccessHandler(displayWorkers)
                .withFailureHandler(error => showMessage('Error al cargar trabajadores: ' + error, 'error'))
                .getWorkers();
        }

        function displayWorkers(data) {
            workers = data;
            const tbody = document.querySelector('#workersTable tbody');
            tbody.innerHTML = '';

            data.forEach(worker => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${worker.id}</td>
                    <td>${worker.nombre}</td>
                    <td>${worker.cargo}</td>
                    <td>${worker.tipo}</td>
                    <td>${worker.fechaIngreso}</td>
                    <td class="actions">
                        <button onclick="editWorker(${worker.id})" class="success">Editar</button>
                        <button onclick="deleteWorker(${worker.id})" class="danger">Eliminar</button>
                    </td>
                `;
            });
        }

        function loadWorkersForSelect() {
            const select = document.getElementById('recordTrabajadorId');
            select.innerHTML = '<option value="">Seleccione un trabajador</option>';
            
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.id;
                option.textContent = `${worker.nombre} (${worker.cargo})`;
                select.appendChild(option);
            });
        }

        function editWorker(id) {
            const worker = workers.find(w => w.id == id);
            if (worker) {
                document.getElementById('workerId').value = worker.id;
                document.getElementById('workerName').value = worker.nombre;
                document.getElementById('workerCargo').value = worker.cargo;
                document.getElementById('workerTipo').value = worker.tipo;
                document.getElementById('workerFechaIngreso').value = worker.fechaIngreso;
            }
        }

        function deleteWorker(id) {
            if (confirm('¿Está seguro de que desea eliminar este trabajador?')) {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Trabajador eliminado correctamente', 'success');
                        loadWorkers();
                    })
                    .withFailureHandler(error => showMessage('Error al eliminar trabajador: ' + error, 'error'))
                    .deleteWorker(id);
            }
        }

        function resetWorkerForm() {
            document.getElementById('workerForm').reset();
            document.getElementById('workerId').value = '';
        }

        // Funciones para registros
        function loadRecords() {
            google.script.run
                .withSuccessHandler(displayRecords)
                .withFailureHandler(error => showMessage('Error al cargar registros: ' + error, 'error'))
                .getRecords();
        }

        function displayRecords(data) {
            records = data;
            const tbody = document.querySelector('#recordsTable tbody');
            tbody.innerHTML = '';

            data.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${record.trabajadorNombre}</td>
                    <td>${record.fecha}</td>
                    <td>${record.horaEntrada}</td>
                    <td>${record.horaSalida || ''}</td>
                    <td class="actions">
                        <button onclick="editRecord(${record.id})" class="success">Editar</button>
                        <button onclick="deleteRecord(${record.id})" class="danger">Eliminar</button>
                    </td>
                `;
            });
        }

        function editRecord(id) {
            const record = records.find(r => r.id == id);
            if (record) {
                document.getElementById('recordId').value = record.id;
                document.getElementById('recordTrabajadorId').value = record.trabajadorId;
                document.getElementById('recordFecha').value = record.fecha;
                document.getElementById('recordHoraEntrada').value = record.horaEntrada;
                document.getElementById('recordHoraSalida').value = record.horaSalida || '';
            }
        }

        function deleteRecord(id) {
            if (confirm('¿Está seguro de que desea eliminar este registro?')) {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Registro eliminado correctamente', 'success');
                        loadRecords();
                    })
                    .withFailureHandler(error => showMessage('Error al eliminar registro: ' + error, 'error'))
                    .deleteRecord(id);
            }
        }

        function resetRecordForm() {
            document.getElementById('recordForm').reset();
            document.getElementById('recordId').value = '';
        }

        // Función para generar reportes
        function generateReport() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;

            if (!fechaInicio || !fechaFin) {
                showMessage('Por favor seleccione ambas fechas', 'error');
                return;
            }

            if (fechaInicio > fechaFin) {
                showMessage('La fecha de inicio no puede ser mayor que la fecha de fin', 'error');
                return;
            }

            google.script.run
                .withSuccessHandler(displayReport)
                .withFailureHandler(error => showMessage('Error al generar reporte: ' + error, 'error'))
                .getWorkersByJobTitle(fechaInicio, fechaFin);
        }

        function displayReport(data) {
            const reportResults = document.getElementById('reportResults');
            const statsContainer = document.getElementById('statsContainer');
            const summaryTableBody = document.querySelector('#summaryTable tbody');

            // Limpiar contenido previo
            statsContainer.innerHTML = '';
            summaryTableBody.innerHTML = '';

            // Calcular estadísticas generales
            let totalWorkers = 0;
            let totalDirectos = 0;
            let totalIndirectos = 0;

            Object.values(data).forEach(cargo => {
                totalWorkers += cargo.total;
                totalDirectos += cargo.directos;
                totalIndirectos += cargo.indirectos;
            });

            // Crear tarjetas de estadísticas
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">Total de Trabajadores</div>
                    <div class="stat-number">${totalWorkers}</div>
                    <div class="stat-subtitle">En el período seleccionado</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Trabajadores Directos</div>
                    <div class="stat-number">${totalDirectos}</div>
                    <div class="stat-subtitle">${totalWorkers > 0 ? ((totalDirectos / totalWorkers) * 100).toFixed(1) : 0}% del total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Trabajadores Indirectos</div>
                    <div class="stat-number">${totalIndirectos}</div>
                    <div class="stat-subtitle">${totalWorkers > 0 ? ((totalIndirectos / totalWorkers) * 100).toFixed(1) : 0}% del total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Cargos Diferentes</div>
                    <div class="stat-number">${Object.keys(data).length}</div>
                    <div class="stat-subtitle">Tipos de cargos encontrados</div>
                </div>
            `;

            // Llenar tabla de resumen
            Object.entries(data).forEach(([cargo, info]) => {
                const row = summaryTableBody.insertRow();
                const porcentajeDirectos = info.total > 0 ? ((info.directos / info.total) * 100).toFixed(1) : 0;
                const porcentajeIndirectos = info.total > 0 ? ((info.indirectos / info.total) * 100).toFixed(1) : 0;

                row.innerHTML = `
                    <td>${cargo}</td>
                    <td>${info.total}</td>
                    <td>${info.directos}</td>
                    <td>${info.indirectos}</td>
                    <td>${porcentajeDirectos}%</td>
                    <td>${porcentajeIndirectos}%</td>
                `;
            });

            reportResults.style.display = 'block';
        }

        // Event listeners para formularios
        document.getElementById('workerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const workerData = {
                id: formData.get('id'),
                nombre: formData.get('nombre'),
                cargo: formData.get('cargo'),
                tipo: formData.get('tipo'),
                fechaIngreso: formData.get('fechaIngreso')
            };

            if (workerData.id) {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Trabajador actualizado correctamente', 'success');
                        resetWorkerForm();
                        loadWorkers();
                    })
                    .withFailureHandler(error => showMessage('Error al actualizar trabajador: ' + error, 'error'))
                    .updateWorker(workerData);
            } else {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Trabajador creado correctamente', 'success');
                        resetWorkerForm();
                        loadWorkers();
                    })
                    .withFailureHandler(error => showMessage('Error al crear trabajador: ' + error, 'error'))
                    .createWorker(workerData);
            }
        });

        document.getElementById('recordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const recordData = {
                id: formData.get('id'),
                trabajadorId: formData.get('trabajadorId'),
                fecha: formData.get('fecha'),
                horaEntrada: formData.get('horaEntrada'),
                horaSalida: formData.get('horaSalida')
            };

            if (recordData.id) {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Registro actualizado correctamente', 'success');
                        resetRecordForm();
                        loadRecords();
                    })
                    .withFailureHandler(error => showMessage('Error al actualizar registro: ' + error, 'error'))
                    .updateRecord(recordData);
            } else {
                google.script.run
                    .withSuccessHandler(() => {
                        showMessage('Registro creado correctamente', 'success');
                        resetRecordForm();
                        loadRecords();
                    })
                    .withFailureHandler(error => showMessage('Error al crear registro: ' + error, 'error'))
                    .createRecord(recordData);
            }
        });

        // Cargar datos iniciales
        window.onload = function() {
            loadWorkers();
        };
    </script>
</body>
</html>
