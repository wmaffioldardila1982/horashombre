<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Horas Hombre - Google Sheets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); padding:20px; min-height:100vh; }
        .container { max-width:1600px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden; }
        .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:30px; text-align:center; }
        .header h1 { font-size:2em; margin-bottom:10px; }
        .config-banner { background:#fff3cd; border-left:4px solid #ffc107; padding:15px 20px; margin:20px; border-radius:5px; }
        .config-banner.success { background:#d4edda; border-left-color:#28a745; }
        .config-banner h3 { color:#856404; margin-bottom:10px; }
        .config-banner.success h3 { color:#155724; }
        .tabs { display:flex; background:#f5f5f5; border-bottom:2px solid #ddd; flex-wrap:wrap; }
        .tab { flex:1; min-width:150px; padding:15px; text-align:center; cursor:pointer; background:#f5f5f5; border:none; font-size:16px; font-weight:600; transition:all .3s; }
        .tab:hover { background:#e0e0e0; }
        .tab.active { background:white; border-bottom:3px solid #667eea; color:#667eea; }
        .content { padding:30px; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .form-group { margin-bottom:20px; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:15px; }
        label { display:block; margin-bottom:5px; font-weight:600; color:#333; }
        input, select, textarea { width:100%; padding:10px; border:2px solid #ddd; border-radius:5px; font-size:14px; transition:border .3s; }
        textarea { min-height:100px; font-family:monospace; }
        input:focus, select:focus, textarea:focus { outline:none; border-color:#667eea; }
        button { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:12px 30px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:600; transition:transform .2s; margin-right:10px; margin-bottom:10px; }
        button:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4); }
        button:disabled { opacity:0.5; cursor:not-allowed; }
        .btn-secondary { background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%); }
        .btn-info { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); }
        .btn-success { background: linear-gradient(135deg,#43e97b 0%,#38f9d7 100%); }
        .btn-warning { background: linear-gradient(135deg,#ffd89b 0%,#ff9a56 100%); }
        table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        th { background:#4a69bd; color:white; padding:12px; text-align:center; font-weight:600; font-size:13px; border:1px solid #fff; }
        td { padding:10px; border:1px solid #ddd; text-align:center; }
        tr:hover { background:#f9f9f9; }
        .delete-btn, .edit-btn { background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; font-size:12px; margin:2px; }
        .edit-btn { background:#3498db; }
        .stats-table { font-size:14px; }
        .periodo-selector { display:flex; gap:15px; margin-bottom:20px; align-items:center; background:#f8f9fa; padding:15px; border-radius:8px; flex-wrap:wrap; }
        .search-box { position:relative; margin-bottom:15px; }
        .trabajador-select { border:2px solid #667eea; background:white; }
        .info-trabajador { background:#e8f5e9; padding:10px; border-radius:5px; margin-top:10px; font-size:13px; }
        .badge { display:inline-block; padding:4px 8px; border-radius:3px; font-size:11px; font-weight:600; margin-left:5px; }
        .badge-directa { background:#3498db; color:white; }
        .badge-indirecta { background:#9b59b6; color:white; }
        .badge-activo { background:#27ae60; color:white; }
        .badge-retirado { background:#e74c3c; color:white; }
        .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); overflow:auto; }
        .modal-content { background:white; margin:50px auto; padding:30px; border-radius:10px; max-width:600px; box-shadow:0 5px 30px rgba(0,0,0,0.3); }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #ddd; }
        .close { font-size:28px; font-weight:bold; cursor:pointer; color:#999; }
        .close:hover { color:#333; }
        .loading { display:none; text-align:center; padding:20px; }
        .loading.active { display:block; }
        .spinner { border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto; }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
        .alert { padding:15px; margin-bottom:20px; border-radius:5px; }
        .alert-info { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; }
        .alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
        .alert-warning { background:#fff3cd; border:1px solid #ffeaa7; color:#856404; }
        .code-block { background:#f8f9fa; border:1px solid #ddd; border-radius:5px; padding:15px; font-family:monospace; font-size:12px; overflow-x:auto; margin:10px 0; }
        .instructions { background:#f8f9fa; padding:20px; border-radius:10px; margin:20px 0; }
        .instructions h3 { color:#667eea; margin-bottom:15px; }
        .instructions ol { margin-left:20px; }
        .instructions li { margin-bottom:10px; line-height:1.6; }
        .sync-status { display:inline-block; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:600; margin-left:10px; }
        .sync-status.synced { background:#d4edda; color:#155724; }
        .sync-status.syncing { background:#fff3cd; color:#856404; }
        .sync-status.error { background:#f8d7da; color:#721c24; }
        .trabajador-checkbox { display:flex; align-items:center; padding:10px; margin:5px 0; background:white; border-radius:5px; cursor:pointer; transition:background .2s; }
        .trabajador-checkbox:hover { background:#e3f2fd; }
        .trabajador-checkbox input[type="checkbox"] { width:20px; height:20px; margin-right:10px; cursor:pointer; }
        .trabajador-checkbox label { margin:0; cursor:pointer; flex:1; }
        .trabajador-info { font-size:12px; color:#666; margin-left:30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Control de Horas Hombre</h1>
            <p>Sistema integrado con Google Sheets</p>
            <span id="syncStatus" class="sync-status"></span>
        </div>

        <div id="configBanner" class="config-banner">
            <h3>‚öôÔ∏è Configuraci√≥n Requerida</h3>
            <p>Para usar esta aplicaci√≥n, primero debes configurar la conexi√≥n con Google Sheets. Ve a la pesta√±a "Configuraci√≥n".</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('configuracion', event)">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab" onclick="showTab('registro', event)" id="tabRegistro" disabled>üìù Registro</button>
            <button class="tab" onclick="showTab('trabajadores', event)" id="tabTrabajadores" disabled>üë• Trabajadores</button>
            <button class="tab" onclick="showTab('estadisticas', event)" id="tabEstadisticas" disabled>üìà Estad√≠sticas</button>
            <button class="tab" onclick="showTab('cargos', event)" id="tabCargos" disabled>üè∑Ô∏è Cargos</button>
            <button class="tab" onclick="showTab('datos', event)" id="tabDatos" disabled>üìã Datos Detallados</button>
        </div>

        <div class="content">
            <!-- CONFIGURACI√ìN -->
            <div id="configuracion" class="tab-content active">
                <h2>Configuraci√≥n de Google Sheets</h2>
                <div class="instructions">
                    <h3>üìã Instrucciones de Configuraci√≥n</h3>
                    <ol>
                        <li><strong>Crea una copia de la plantilla de Google Sheets:</strong>
                            <br><a href="#" target="_blank" style="color:#667eea;">Haz clic aqu√≠ para copiar la plantilla (reemplaza por tu link)</a>
                        </li>
                        <li><strong>Abre tu copia y ve a:</strong> Extensiones ‚Üí Apps Script</li>
                        <li><strong>Copia y pega el Apps Script</strong> que tengas (o el que te pas√© anteriormente).</li>
                        <li><strong>Implementa</strong> como Aplicaci√≥n web y copia la URL que termina en <code>/exec</code>.</li>
                        <li>P√©gala abajo y guarda la configuraci√≥n.</li>
                    </ol>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Importante:</strong> La URL debe terminar en <code>/exec</code> (no en <code>/dev</code>)
                </div>

                <form id="configForm">
                    <div class="form-group">
                        <label for="webAppUrl">URL de tu Web App de Google Sheets:</label>
                        <input type="url" id="webAppUrl" placeholder="https://script.google.com/macros/s/TU_ID/exec" required>
                    </div>
                    <button type="submit">üíæ Guardar y Probar Conexi√≥n</button>
                    <button type="button" class="btn-warning" onclick="crearPlantillaLocal()">üìÑ Crear Plantilla Manual</button>
                </form>

                <div id="loadingConfig" class="loading">
                    <div class="spinner"></div>
                    <p>Probando conexi√≥n...</p>
                </div>
            </div>

            <!-- REGISTRO -->
            <div id="registro" class="tab-content">
                <h2>Registrar Horas</h2>
                <div style="margin-bottom:20px;">
                    <button onclick="mostrarRegistroSimple()" class="btn-info">üìù Registro Simple</button>
                    <button onclick="mostrarRegistroMasivo()" class="btn-success">üë• Registro Masivo</button>
                    <button onclick="importarRegistrosExcel()" class="btn-warning">üì§ Importar Excel</button>
                    <input type="file" id="fileImportRegistros" accept=".xlsx,.xls" style="display:none" onchange="procesarArchivoRegistros(event)">
                </div>

                <div id="formSimple">
                    <form id="registroForm">
                        <div class="form-row">
                            <div class="form-group"><label for="fecha">Fecha:</label><input type="date" id="fecha" required></div>
                            <div class="form-group"><label for="trabajadorSelect">Trabajador:</label><select id="trabajadorSelect" class="trabajador-select" required><option value="">-- Seleccione un trabajador --</option></select></div>
                        </div>

                        <div id="infoTrabajador" class="info-trabajador" style="display:none;"></div>

                        <div class="form-row">
                            <div class="form-group"><label for="frente">Frente de Trabajo:</label><input type="text" id="frente" placeholder="Ej: K948, PLANEACI√ìN" required list="frentesList"><datalist id="frentesList">
                                <option value="PLANEACI√ìN"><option value="ADMINISTRATIVO"><option value="K948"><option value="K90z"><option value="K940"><option value="K939"><option value="K935"><option value="K104"><option value="K95">
                            </datalist></div>
                            <div class="form-group"><label for="horasDirecta">Horas Directa:</label><input type="number" id="horasDirecta" step="0.5" min="0" placeholder="0" value="0"></div>
                            <div class="form-group"><label for="horasIndirecta">Horas Indirecta:</label><input type="number" id="horasIndirecta" step="0.5" min="0" placeholder="0" value="0"></div>
                        </div>
                        <button type="submit">Agregar Registro</button>
                        <button type="button" class="btn-info" onclick="sincronizar()">üîÑ Sincronizar</button>
                    </form>
                </div>

                <div id="formMasivo" style="display:none;">
                    <form id="registroMasivoForm">
                        <div class="form-row">
                            <div class="form-group"><label for="fechaMasiva">Fecha:</label><input type="date" id="fechaMasiva" required></div>
                            <div class="form-group"><label for="frenteMasivo">Frente de Trabajo:</label><input type="text" id="frenteMasivo" placeholder="Ej: K948" required list="frentesList"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="horasDirectaMasiva">Horas Directa (por defecto):</label><input type="number" id="horasDirectaMasiva" step="0.5" min="0" placeholder="8" value="8"></div>
                            <div class="form-group"><label for="horasIndirectaMasiva">Horas Indirecta (por defecto):</label><input type="number" id="horasIndirectaMasiva" step="0.5" min="0" placeholder="0" value="0"></div>
                        </div>
                        <div class="form-group">
                            <label>Selecciona los trabajadores:</label>
                            <div class="search-box"><input type="text" id="buscarTrabajadorMasivo" placeholder="üîç Buscar trabajador..." onkeyup="filtrarTrabajadoresMasivo()"></div>
                            <div style="background:#f8f9fa; padding:15px; border-radius:8px; max-height:400px; overflow-y:auto;">
                                <div style="margin-bottom:10px;"><button type="button" onclick="seleccionarTodosTrabajadores()" class="btn-info">‚úì Seleccionar Todos</button><button type="button" onclick="deseleccionarTodosTrabajadores()" class="btn-secondary">‚úó Deseleccionar Todos</button><span id="contadorSeleccionados" style="margin-left:15px; font-weight:600;"></span></div>
                                <div id="listaTrabajadoresMasivo"></div>
                            </div>
                        </div>
                        <button type="submit">üíæ Registrar Todos</button>
                        <button type="button" class="btn-secondary" onclick="mostrarRegistroSimple()">Cancelar</button>
                    </form>
                </div>

                <div id="loadingRegistro" class="loading"><div class="spinner"></div><p>Guardando...</p></div>
            </div>

            <!-- TRABAJADORES -->
            <div id="trabajadores" class="tab-content">
                <h2>Gesti√≥n de Trabajadores</h2>
                <button onclick="mostrarModalTrabajador()">‚ûï Nuevo Trabajador</button>
                <button class="btn-info" onclick="sincronizar()">üîÑ Sincronizar</button>
                <div class="search-box"><input type="text" id="buscarTrabajador" placeholder="üîç Buscar por nombre, c√©dula o cargo..." onkeyup="filtrarTrabajadores()"></div>
                <div style="overflow-x:auto;"><table id="tablaTrabajadores"><thead><tr><th>C√©dula</th><th>Nombre Completo</th><th>Cargo</th><th>Tipo de Cargo</th><th>Fecha Ingreso</th><th>Fecha Retiro</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="bodyTrabajadores"></tbody></table></div>
                <div id="loadingTrabajadores" class="loading"><div class="spinner"></div><p>Cargando trabajadores...</p></div>
            </div>

            <!-- ESTADISTICAS -->
            <div id="estadisticas" class="tab-content">
                <h2>Estad√≠sticas del Proyecto</h2>
                <div class="periodo-selector"><label for="fechaInicio">Per√≠odo desde:</label><input type="date" id="fechaInicio"><label for="fechaFin">hasta:</label><input type="date" id="fechaFin"><button onclick="actualizarEstadisticas()">Actualizar</button></div>
                <div style="overflow-x:auto;"><table class="stats-table" id="tabla-estadisticas"><thead><tr><th>FRENTE</th><th>PERSONAL DIRECTA</th><th>PERSONAL INDIRECTA</th><th>HORAS DIRECTA</th><th>HORAS INDIRECTA</th><th>ACUMULADO</th></tr></thead><tbody id="statsBody"></tbody></table></div>
            </div>

            <!-- CARGOS -->
            <div id="cargos" class="tab-content">
                <h2>Estad√≠sticas por Cargos</h2>
                <div class="periodo-selector"><label for="fechaInicioC">Per√≠odo desde:</label><input type="date" id="fechaInicioC"><label for="fechaFinC">hasta:</label><input type="date" id="fechaFinC"><button onclick="actualizarCargos()">Actualizar Cargos</button></div>
                <div style="overflow-x:auto;"><table id="tablaCargos"><thead><tr><th>CARGO</th><th>CANTIDAD DE PERSONAS (√öNICAS)</th></tr></thead><tbody id="bodyCargos"></tbody><tfoot id="footCargos"></tfoot></table></div>
                <p style="margin-top:10px; font-size:13px; color:#555;">Nota: se cuenta cada trabajador una sola vez por cargo en el per√≠odo seleccionado.</p>
            </div>

            <!-- DATOS DETALLADOS -->
            <div id="datos" class="tab-content">
                <h2>Registros Detallados</h2>
                <div style="overflow-x:auto;"><table id="tablaRegistros"><thead><tr><th>Fecha</th><th>Trabajador</th><th>C√©dula</th><th>Frente</th><th>Horas Directa</th><th>Horas Indirecta</th><th>Total Horas</th><th>Acci√≥n</th></tr></thead><tbody id="bodyRegistros"></tbody></table></div>
            </div>

        </div>
    </div>

    <!-- MODAL TRABAJADOR -->
    <div id="modalTrabajador" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modalTitle">Nuevo Trabajador</h2><span class="close" onclick="cerrarModalTrabajador()">&times;</span></div>
        <form id="formTrabajador"><input type="hidden" id="cedulaOriginal"><div class="form-group"><label for="cedula">N√∫mero de C√©dula:</label><input type="text" id="cedula" required></div><div class="form-group"><label for="nombreCompleto">Nombre Completo:</label><input type="text" id="nombreCompleto" required></div><div class="form-group"><label for="cargo">Cargo:</label><input type="text" id="cargo" required></div><div class="form-group"><label for="tipoCargo">Tipo de Cargo:</label><select id="tipoCargo" required><option value="">-- Seleccione --</option><option value="Directa">Directa</option><option value="Indirecta">Indirecta</option></select></div><div class="form-group"><label for="fechaIngreso">Fecha de Ingreso:</label><input type="date" id="fechaIngreso" required></div><div class="form-group"><label for="fechaRetiro">Fecha de Retiro (opcional):</label><input type="date" id="fechaRetiro"></div><button type="submit">Guardar Trabajador</button><button type="button" class="btn-secondary" onclick="cerrarModalTrabajador()">Cancelar</button></form>
    </div></div>

    <script>
        // Estado local
        let registros = [];
        let trabajadores = [];
        let webAppUrl = '';
        let isConfigured = false;

        // Inicializar fechas
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaMasiva').valueAsDate = new Date();
            const hoy = new Date();
            document.getElementById('fechaFin').valueAsDate = hoy;
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            document.getElementById('fechaInicio').valueAsDate = inicioMes;
            // cargos period defaults
            document.getElementById('fechaFinC').valueAsDate = hoy;
            document.getElementById('fechaInicioC').valueAsDate = inicioMes;

            cargarConfiguracion();
        });

        // CONFIG FORM
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            webAppUrl = document.getElementById('webAppUrl').value.trim();
            document.getElementById('loadingConfig').classList.add('active');
            try {
                const response = await fetch(webAppUrl + '?action=getTrabajadores');
                if (!response.ok) throw new Error('Error en la respuesta: ' + response.status);
                const data = await response.json();
                localStorage.setItem('webAppUrl', webAppUrl);
                isConfigured = true;
                document.getElementById('configBanner').innerHTML = '<h3>‚úÖ Configuraci√≥n Exitosa</h3><p>La conexi√≥n con Google Sheets funciona correctamente.</p>';
                document.getElementById('configBanner').className = 'config-banner success';
                document.getElementById('tabRegistro').disabled = false;
                document.getElementById('tabTrabajadores').disabled = false;
                document.getElementById('tabEstadisticas').disabled = false;
                document.getElementById('tabCargos').disabled = false;
                document.getElementById('tabDatos').disabled = false;
                document.getElementById('loadingConfig').classList.remove('active');
                await sincronizar();
                alert('‚úÖ Configuraci√≥n guardada exitosamente');
                // switch to registro
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById('registro').classList.add('active');
                document.querySelector('[onclick="showTab(\'registro\', event)"]').classList.add('active');
            } catch (error) {
                document.getElementById('loadingConfig').classList.remove('active');
                alert('‚ùå Error al conectar con Google Sheets:\n' + error.message + '\n\nVerifica la URL y permisos');
                console.error(error);
            }
        });

        // SINCRONIZAR
        async function sincronizar() {
            if (!isConfigured) return;
            setSyncStatus('syncing');
            try {
                const resTrab = await fetch(webAppUrl + '?action=getTrabajadores');
                const dataTrab = await resTrab.json();
                trabajadores = dataTrab.map(row => {
                    // row indices assumed: 0:cedula,1:nombre,2:cargo,3:tipo,4:ingreso,5:retiro
                    const normalizarFecha = (fecha) => {
                        if (!fecha) return null;
                        if (typeof fecha === 'string' && fecha.includes('T')) return fecha.split('T')[0];
                        if (typeof fecha === 'number') return convertirFechaSerial(fecha);
                        if (typeof fecha === 'string' && fecha.includes('/')) { const p = fecha.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; }
                        if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
                        return fecha;
                    };
                    return { cedula: String(row[0]), nombreCompleto: row[1], cargo: row[2], tipoCargo: row[3], fechaIngreso: normalizarFecha(row[4]), fechaRetiro: normalizarFecha(row[5]) };
                });

                const resReg = await fetch(webAppUrl + '?action=getRegistros');
                const dataReg = await resReg.json();
                registros = dataReg.map(row => {
                    // assume: 0:id,1:fecha,2:trabajadorNombre,3:trabajadorCedula,4:frente,5:horasDir,6:horasInd
                    let fecha = row[1];
                    if (typeof fecha === 'string' && fecha.includes('T')) fecha = fecha.split('T')[0];
                    else if (typeof fecha === 'number') fecha = convertirFechaSerial(fecha);
                    else if (fecha instanceof Date) fecha = fecha.toISOString().split('T')[0];
                    return { id: row[0] || (Date.now()+Math.random()), fecha: fecha, trabajadorNombre: row[2], trabajadorCedula: String(row[3]), frente: row[4], horasDirecta: parseFloat(row[5])||0, horasIndirecta: parseFloat(row[6])||0 };
                });

                actualizarSelectTrabajadores();
                actualizarTablaTrabajadores();
                actualizarTabla();
                actualizarEstadisticas();
                actualizarCargos();
                setSyncStatus('synced');
            } catch (error) {
                setSyncStatus('error');
                console.error('Error sincronizar:', error);
            }
        }

        function setSyncStatus(status) { const s = document.getElementById('syncStatus'); s.className = 'sync-status ' + status; if (status==='synced') s.textContent='‚úì Sincronizado'; else if (status==='syncing') s.textContent='‚ü≥ Sincronizando...'; else if (status==='error') s.textContent='‚ö† Error de conexi√≥n'; else s.textContent=''; }

        function convertirFechaSerial(serial) { const diasDesde1900 = serial - 1; const fecha = new Date(1899,11,30); fecha.setDate(fecha.getDate() + diasDesde1900); const year = fecha.getFullYear(); const month = String(fecha.getMonth()+1).padStart(2,'0'); const day = String(fecha.getDate()).padStart(2,'0'); return `${year}-${month}-${day}`; }

        // ACTUALIZAR SELECT Y TABLAS
        function actualizarSelectTrabajadores() {
            const select = document.getElementById('trabajadorSelect'); select.innerHTML = '<option value="">-- Seleccione un trabajador --</option>';
            trabajadores.filter(t=>!t.fechaRetiro).sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto)).forEach(trabajador=>{ const option=document.createElement('option'); option.value=trabajador.cedula; option.textContent=`${trabajador.nombreCompleto} (${trabajador.cedula})`; select.appendChild(option); });
        }

        function actualizarTablaTrabajadores() {
            const tbody = document.getElementById('bodyTrabajadores'); tbody.innerHTML='';
            trabajadores.sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto)).forEach(trabajador=>{
                const tr=document.createElement('tr'); const estado = trabajador.fechaRetiro? '<span class="badge badge-retirado">Retirado</span>' : '<span class="badge badge-activo">Activo</span>';
                let fechaIngresoForm='-'; let fechaRetiroForm='-'; try{ if (trabajador.fechaIngreso){ const f=new Date(trabajador.fechaIngreso + 'T00:00:00'); if (!isNaN(f.getTime())) fechaIngresoForm=f.toLocaleDateString('es-ES'); else fechaIngresoForm=trabajador.fechaIngreso; } } catch(e){ fechaIngresoForm=trabajador.fechaIngreso; }
                try{ if (trabajador.fechaRetiro){ const f=new Date(trabajador.fechaRetiro + 'T00:00:00'); if (!isNaN(f.getTime())) fechaRetiroForm=f.toLocaleDateString('es-ES'); else fechaRetiroForm=trabajador.fechaRetiro; } } catch(e){ fechaRetiroForm=trabajador.fechaRetiro; }
                tr.innerHTML=`<td>${trabajador.cedula}</td><td style="text-align:left;">${trabajador.nombreCompleto}</td><td>${trabajador.cargo}</td><td>${trabajador.tipoCargo}</td><td>${fechaIngresoForm}</td><td>${fechaRetiroForm}</td><td>${estado}</td><td><button class="edit-btn" onclick="editarTrabajador('${trabajador.cedula}')">Editar</button><button class="delete-btn" onclick="eliminarTrabajador('${trabajador.cedula}')">Eliminar</button></td>`;
                tbody.appendChild(tr);
            });
        }

        function actualizarTabla() {
            const tbody = document.getElementById('bodyRegistros'); tbody.innerHTML='';
            registros.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
            registros.forEach(registro=>{
                let fechaForm='-'; try{ const f=new Date(registro.fecha + 'T00:00:00'); if (!isNaN(f.getTime())) fechaForm=f.toLocaleDateString('es-ES'); else fechaForm=registro.fecha;}catch(e){fechaForm=registro.fecha}
                const tr=document.createElement('tr'); tr.innerHTML=`<td>${fechaForm}</td><td>${registro.trabajadorNombre}</td><td>${registro.trabajadorCedula}</td><td>${registro.frente}</td><td>${registro.horasDirecta.toFixed(2)}</td><td>${registro.horasIndirecta.toFixed(2)}</td><td><strong>${(registro.horasDirecta+registro.horasIndirecta).toFixed(2)}</strong></td><td><button class="delete-btn" onclick="eliminarRegistro('${registro.id}')">Eliminar</button></td>`; tbody.appendChild(tr);
            });
        }

        // EVENTOS DE FORMULARIOS (simplified / reused from original)
        document.getElementById('registroForm').addEventListener('submit', async function(e){ e.preventDefault(); if(!isConfigured){ alert('Primero debes configurar la conexi√≥n con Google Sheets'); return;} const horasDirecta=parseFloat(document.getElementById('horasDirecta').value)||0; const horasIndirecta=parseFloat(document.getElementById('horasIndirecta').value)||0; if(horasDirecta===0 && horasIndirecta===0){ alert('Debe ingresar al menos horas directas o indirectas'); return;} const trabajadorCedula=document.getElementById('trabajadorSelect').value; const trabajador=trabajadores.find(t=>t.cedula===trabajadorCedula); if(!trabajador){ alert('Debe seleccionar un trabajador v√°lido'); return;} const registro={ id: Date.now()+Math.random(), fecha: document.getElementById('fecha').value, trabajadorNombre: trabajador.nombreCompleto, trabajadorCedula: trabajador.cedula, frente: document.getElementById('frente').value.toUpperCase(), horasDirecta: horasDirecta, horasIndirecta: horasIndirecta }; document.getElementById('loadingRegistro').classList.add('active'); try{ await fetch(webAppUrl, { method:'POST', body: JSON.stringify({ action:'addRegistro', ...registro }) }); registros.push(registro); actualizarTabla(); setSyncStatus('synced'); alert('‚úì Registro agregado exitosamente'); this.reset(); document.getElementById('fecha').valueAsDate = new Date(); document.getElementById('horasDirecta').value='0'; document.getElementById('horasIndirecta').value='0'; }catch(err){ setSyncStatus('error'); alert('‚ùå Error al guardar.'); console.error(err);} finally{ document.getElementById('loadingRegistro').classList.remove('active'); }});

        // Simplified trabajador form
        document.getElementById('formTrabajador').addEventListener('submit', async function(e){ e.preventDefault(); const cedulaOriginal=document.getElementById('cedulaOriginal').value; const esEdicion = cedulaOriginal !== ''; const trabajadorData={ cedula: document.getElementById('cedula').value, nombreCompleto: document.getElementById('nombreCompleto').value, cargo: document.getElementById('cargo').value, tipoCargo: document.getElementById('tipoCargo').value, fechaIngreso: document.getElementById('fechaIngreso').value, fechaRetiro: document.getElementById('fechaRetiro').value || '' }; try{ if(esEdicion){ await fetch(webAppUrl, { method:'POST', body: JSON.stringify({ action:'updateTrabajador', ...trabajadorData }) }); const idx = trabajadores.findIndex(t=>t.cedula===cedulaOriginal); if(idx!==-1) trabajadores[idx]=trabajadorData; } else { await fetch(webAppUrl, { method:'POST', body: JSON.stringify({ action:'addTrabajador', ...trabajadorData }) }); trabajadores.push(trabajadorData); } actualizarTablaTrabajadores(); actualizarSelectTrabajadores(); cerrarModalTrabajador(); setSyncStatus('synced'); alert('‚úì Trabajador guardado exitosamente'); }catch(err){ setSyncStatus('error'); alert('‚ùå Error al guardar.'); console.error(err);} });

        // Eliminar trabajador
        async function eliminarTrabajador(cedula){ const trabajador = trabajadores.find(t=>t.cedula===cedula); const tieneRegistros = registros.some(r=>r.trabajadorCedula===cedula); let mensaje = `¬øEst√° seguro de eliminar a ${trabajador?trabajador.nombreCompleto:cedula}?`; if(tieneRegistros) mensaje += '\n\nADVERTENCIA: Tiene registros asociados.'; if(confirm(mensaje)){ try{ await fetch(webAppUrl, { method:'POST', body: JSON.stringify({ action:'deleteTrabajador', cedula }) }); trabajadores = trabajadores.filter(t=>t.cedula!==cedula); actualizarTablaTrabajadores(); actualizarSelectTrabajadores(); setSyncStatus('synced'); }catch(err){ setSyncStatus('error'); alert('‚ùå Error al eliminar.'); console.error(err);} } }

        function mostrarModalTrabajador(){ document.getElementById('cedulaOriginal').value=''; document.getElementById('modalTitle').textContent='Nuevo Trabajador'; document.getElementById('formTrabajador').reset(); document.getElementById('modalTrabajador').style.display='block'; }
        function cerrarModalTrabajador(){ document.getElementById('modalTrabajador').style.display='none'; }
        function editarTrabajador(cedula){ const t = trabajadores.find(x=>x.cedula===cedula); if(!t) return; document.getElementById('cedulaOriginal').value=cedula; document.getElementById('modalTitle').textContent='Editar Trabajador'; document.getElementById('cedula').value=t.cedula; document.getElementById('nombreCompleto').value=t.nombreCompleto; document.getElementById('cargo').value=t.cargo; document.getElementById('tipoCargo').value=t.tipoCargo; document.getElementById('fechaIngreso').value=t.fechaIngreso; document.getElementById('fechaRetiro').value=t.fechaRetiro||''; document.getElementById('modalTrabajador').style.display='block'; }

        // Eliminar registro
        async function eliminarRegistro(id){ if(!confirm('¬øEst√° seguro de eliminar este registro?')) return; const registro = registros.find(r=>r.id==id); if(!registro){ alert('Registro no encontrado'); return; } document.getElementById('loadingRegistro').classList.add('active'); try{ const res = await fetch(webAppUrl, { method:'POST', body: JSON.stringify({ action:'deleteRegistro', id:id, fecha: registro.fecha, cedula: registro.trabajadorCedula, frente: registro.frente }) }); const result = await res.json(); if(result.success){ registros = registros.filter(r=>r.id!=id); actualizarTabla(); setSyncStatus('synced'); alert('‚úì Registro eliminado exitosamente'); } else { throw new Error(result.error||'No confirmado'); } }catch(err){ setSyncStatus('error'); alert('‚ùå Error al eliminar: '+err.message); console.error(err);} finally{ document.getElementById('loadingRegistro').classList.remove('active'); } }

        // Pesta√±as
        function showTab(tabName, event){ document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById(tabName).classList.add('active'); if(event && event.currentTarget) event.currentTarget.classList.add('active'); // actualizar si es estadisticas o cargos
            if(tabName==='estadisticas'){ actualizarEstadisticas(); }
            if(tabName==='cargos'){ actualizarCargos(); }
        }

        // UTIL: normalizar fecha
        function normalizarFechaGenerica(f){ if(!f) return null; if(typeof f==='string' && f.includes('T')) return f.split('T')[0]; if(typeof f==='string' && /^\d{4}-\d{2}-\d{2}$/.test(f)) return f; if(typeof f==='string' && f.includes('/')){ const p=f.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; } if(typeof f==='number'){ return convertirFechaSerial(f); } return f; }

        // ACTUALIZAR ESTADISTICAS (frentes)
        function actualizarEstadisticas(){ const fechaInicio=document.getElementById('fechaInicio').value; const fechaFin=document.getElementById('fechaFin').value; if(!fechaInicio||!fechaFin) return; const ini=normalizarFechaGenerica(fechaInicio); const fin=normalizarFechaGenerica(fechaFin); const estadisticas={}; registros.forEach(r=>{ const fechaR=normalizarFechaGenerica(r.fecha); if(!(fechaR>=ini && fechaR<=fin)) return; if(!estadisticas[r.frente]) estadisticas[r.frente]={ personalDirectaPeriodo:new Set(), personalIndirectaPeriodo:new Set(), horasDirectaPeriodo:0, horasIndirectaPeriodo:0, horasDirectaAcumulado:0, horasIndirectaAcumulado:0 }; if(r.horasDirecta>0) estadisticas[r.frente].personalDirectaPeriodo.add(r.trabajadorCedula); if(r.horasIndirecta>0) estadisticas[r.frente].personalIndirectaPeriodo.add(r.trabajadorCedula); estadisticas[r.frente].horasDirectaPeriodo+=r.horasDirecta; estadisticas[r.frente].horasIndirectaPeriodo+=r.horasIndirecta; estadisticas[r.frente].horasDirectaAcumulado+=r.horasDirecta; estadisticas[r.frente].horasIndirectaAcumulado+=r.horasIndirecta; }); const tbody=document.getElementById('statsBody'); tbody.innerHTML=''; let totalPersonalDirecta=0, totalPersonalIndirecta=0, totalHorasDirectaPeriodo=0, totalHorasIndirectaPeriodo=0, totalHorasDirectaAcum=0, totalHorasIndirectaAcum=0; Object.keys(estadisticas).sort().forEach(frente=>{ const s=estadisticas[frente]; const cantDirecta=s.personalDirectaPeriodo.size; const cantIndirecta=s.personalIndirectaPeriodo.size; totalPersonalDirecta+=cantDirecta; totalPersonalIndirecta+=cantIndirecta; totalHorasDirectaPeriodo+=s.horasDirectaPeriodo; totalHorasIndirectaPeriodo+=s.horasIndirectaPeriodo; totalHorasDirectaAcum+=s.horasDirectaAcumulado; totalHorasIndirectaAcum+=s.horasIndirectaAcumulado; const tr=document.createElement('tr'); tr.innerHTML=`<td class="frente-col">${frente}</td><td>${cantDirecta}</td><td>${cantIndirecta}</td><td>${s.horasDirectaPeriodo.toFixed(2)}</td><td>${s.horasIndirectaPeriodo.toFixed(2)}</td><td>${(s.horasDirectaAcumulado+s.horasIndirectaAcumulado).toFixed(2)}</td>`; tbody.appendChild(tr); }); const subtotalRow=document.createElement('tr'); subtotalRow.className='subtotal-row'; subtotalRow.innerHTML=`<td class="frente-col">Subtotal</td><td>${totalPersonalDirecta}</td><td>${totalPersonalIndirecta}</td><td>${totalHorasDirectaPeriodo.toFixed(2)}</td><td>${totalHorasIndirectaPeriodo.toFixed(2)}</td><td>${(totalHorasDirectaAcum+totalHorasIndirectaAcum).toFixed(2)}</td>`; tbody.appendChild(subtotalRow); const totalRow=document.createElement('tr'); totalRow.className='total-row'; totalRow.innerHTML=`<td class="frente-col">Total</td><td colspan="2">${totalPersonalDirecta+totalPersonalIndirecta}</td><td colspan="2">${(totalHorasDirectaPeriodo+totalHorasIndirectaPeriodo).toFixed(2)}</td><td colspan="2">${(totalHorasDirectaAcum+totalHorasIndirectaAcum).toFixed(2)}</td>`; tbody.appendChild(totalRow); }

        // === NUEVA FUNCI√ìN: actualizarCargos ===
        // Cuenta la cantidad de personas √∫nicas por CARGO dentro del rango de fechas seleccionado.
        function actualizarCargos(){ const fechaInicio=document.getElementById('fechaInicioC').value; const fechaFin=document.getElementById('fechaFinC').value; if(!fechaInicio||!fechaFin){ alert('Selecciona un per√≠odo para Cargos'); return; } const ini=normalizarFechaGenerica(fechaInicio); const fin=normalizarFechaGenerica(fechaFin); const cargosMap = {}; // cargo -> Set(cedulas)

            // Recorremos registros para identificar qu√© trabajadores tuvieron actividad en el per√≠odo
            registros.forEach(r=>{
                const fechaR = normalizarFechaGenerica(r.fecha);
                if(!(fechaR>=ini && fechaR<=fin)) return;
                // Buscar el trabajador para obtener su cargo actual (o hist√≥rico)
                const t = trabajadores.find(x=>String(x.cedula)===String(r.trabajadorCedula));
                const cargoName = (t && t.cargo) ? String(t.cargo).trim() : 'Sin cargo';
                if(!cargosMap[cargoName]) cargosMap[cargoName] = new Set();
                cargosMap[cargoName].add(String(r.trabajadorCedula));
            });

            // Tambi√©n considerar trabajadores que no tienen registros en el per√≠odo pero quieras contarlos?  (No, seg√∫n pedido solo por rango de periodo)

            // Renderizar tabla
            const tbody = document.getElementById('bodyCargos'); tbody.innerHTML='';
            const foot = document.getElementById('footCargos'); foot.innerHTML='';
            let totalPersonas = 0;
            Object.keys(cargosMap).sort().forEach(cargo => {
                const count = cargosMap[cargo].size;
                totalPersonas += count;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="text-align:left;">${cargo}</td><td>${count}</td>`;
                tbody.appendChild(tr);
            });
            // Si no hay resultados, indicar
            if(Object.keys(cargosMap).length===0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="2">No se encontraron registros en el per√≠odo seleccionado.</td>`; tbody.appendChild(tr); }

            // Footer con totales
            const trFoot = document.createElement('tr'); trFoot.innerHTML = `<td style="font-weight:700;">Total</td><td style="font-weight:700;">${totalPersonas}</td>`; foot.appendChild(trFoot);
        }

        // IMPORTAR EXCEL (simplified)
        function importarRegistrosExcel(){ document.getElementById('fileImportRegistros').click(); }
        async function procesarArchivoRegistros(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = async function(evt){ try{ const data=new Uint8Array(evt.target.result); const workbook=XLSX.read(data,{type:'array'}); const first=workbook.Sheets[workbook.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(first); if(json.length===0){ alert('Archivo vac√≠o'); return; } document.getElementById('loadingRegistro').classList.add('active'); let importados=0, errores=0; for(let i=0;i<json.length;i++){ const row=json[i]; const cedula = row['Cedula']||row['C√©dula']||row['cedula']||row['CEDULA']; const fecha = row['Fecha']||row['fecha']||row['FECHA']; const frente = row['Frente']||row['frente']||row['FRENTE']; const horasDirecta = row['Horas Directa']||row['HorasDirecta']||row['Directa']||0; const horasIndirecta = row['Horas Indirecta']||row['HorasIndirecta']||row['Indirecta']||0; if(!cedula||!fecha||!frente){ errores++; continue; } const trabajador = trabajadores.find(t=>t.cedula===String(cedula)); if(!trabajador){ errores++; continue; } let fechaForm; if(typeof fecha==='number') fechaForm = convertirFechaSerial(fecha); else if(typeof fecha==='string' && fecha.includes('/')){ const p=fecha.split('/'); fechaForm=`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`; } else if(typeof fecha==='string') fechaForm = fecha.split('T')[0]; else fechaForm = fecha; const registro = { fecha: fechaForm, trabajadorNombre: trabajador.nombreCompleto, trabajadorCedula: trabajador.cedula, frente: String(frente).toUpperCase(), horasDirecta: parseFloat(horasDirecta)||0, horasIndirecta: parseFloat(horasIndirecta)||0 }; try{ await fetch(webAppUrl,{ method:'POST', body: JSON.stringify({ action:'addRegistro', ...registro }) }); registros.push(registro); importados++; }catch(err){ errores++; console.error(err); } }
            actualizarTabla(); actualizarEstadisticas(); actualizarCargos(); setSyncStatus('synced'); alert(`Importaci√≥n finalizada. Importados: ${importados}, Errores: ${errores}`);
        }catch(err){ console.error(err); alert('Error al procesar archivo'); } finally{ document.getElementById('loadingRegistro').classList.remove('active'); }}; reader.readAsArrayBuffer(file); }

    </script>
</body>
</html>
